

desc 'Execute js tests'
lane :tests do
  sh 'yarn lint'
  sh 'yarn tsc'
  sh 'yarn test'
end

before_all do
  skip_docs
  sh 'yarn install'
end

desc 'Build Dev apps'
lane :build_dev do
  build_ios_dev
  build_android_dev
end

desc 'Build iOS Dev app'
lane :build_ios_dev do
  sh 'yarn install-ios'

  match(
    type: 'development',
    readonly: true,
  )

  ENV["ENVFILE"] = ".env.dev"
  build_ios_app(
    export_method: 'development',
    workspace: 'ios/MindBlown.xcworkspace',
    scheme: 'MindBlown',
    configuration: 'Debug',
    skip_package_ipa: true,
    skip_archive: true,
    destination: 'platform=iOS Simulator,name=iPhone 8,OS=12.1'
  )
end

desc 'Build iOS QA'
lane :build_ios_qa do
  sh 'yarn install-ios'

  match(
    type: 'appstore',
    readonly: true,
  )

  ENV["ENVFILE"] = ".env.adhoc"
  build_ios_app(
    export_method: 'app-store',
    workspace: 'ios/MindBlown.xcworkspace',
    scheme: 'MindBlown',
    configuration: 'AdHoc',
    output_directory: 'build/',
  )
end


desc 'Build iOS Distribution'
lane :build_ios_dist do
  sh 'yarn install-ios'

  match(
    type: 'appstore',
    readonly: true,
  )

  ENV["ENVFILE"] = ".env.prod"
  build_ios_app(
    export_method: 'app-store',
    workspace: 'ios/MindBlown.xcworkspace',
    scheme: 'MindBlown',
    configuration: 'Release',
    output_directory: 'build/',
  )
end



desc 'Release iOS QA to TestFlight'
lane :release_ios_dist do
  build_ios_dist

  upload_to_testflight(
    ipa: 'build/MindBlown.ipa',
    skip_waiting_for_build_processing: true,
  )
end

desc 'Build Android Dev app'
lane :build_android_dev do
  ENV["ENVFILE"] = ".env.dev"

  gradle(task: 'clean', project_dir: 'android/')
  gradle(task: 'assemble', build_type: 'Debug', project_dir: 'android/')

  cp_to_deploy()
end

desc 'Build Android Release app'
lane :build_android_release do
  ENV["ENVFILE"] = ".env.prod"

  gradle(task: 'clean', project_dir: 'android/')
  gradle(task: 'assemble', build_type: 'Release', project_dir: 'android/')

  cp_to_deploy()
end

desc 'Release Android app'
lane :release_android do
  build_android_release

  upload_to_play_store(
    package_name: 'com.shufflow.MindBlown',
    track: 'alpha',
    json_key: 'google_api_key.json',
    apk: lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH],
  )
end

def cp_to_deploy()
  apk_location = "#{lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]}"
  out_dir = ENV['BITRISE_DEPLOY_DIR'] || '../build/'

  UI.message "Moving bundle to \"#{out_dir}\""
  sh "cp #{apk_location} #{out_dir}"
end
